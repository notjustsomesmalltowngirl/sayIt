<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Inter:ital,
      opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Oswald
      :wght@200..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="icon"
      type="image/png"
      href="../static/sayIt-logos/logo-mono.png"
    />
    <link rel="stylesheet" href="../static/styles/main.css" />
    <title>sayIt | Discussions</title>
  </head>
  <body>
    <div class="whole-container">
      <div class="news-container container">
        <div class="categories">
          <!-- <h3 class="categories__title">Browse by Category</h3> -->
          <div class="categories__grid">
            {% for cat in categories %}
            <!--  {# looping through each category all of which have been injected globally #}-->
            <a
              href="{{ url_for('goto_category', category=cat) }}"
              class="category {% if cat == active_category %}active{% endif %}"
              >{{ cat.capitalize() }}</a
            >
            {% endfor %}
          </div>
        </div>
        <!-- Article Section -->
        {% if article %}
        <!--{# check if article exists #} -->
        <header class="news">
          <h1 class="news__title">{{ article.headline }}</h1>
          <p class="news__content">{{ article.description }}</p>
          <a
            href="{{ article.url }}"
            target="_blank"
            class="cta-button news-cta__btn"
            >Read More</a
          >
          <div class="news__meta">
            <div class="news__date">
              <span>üìÖ</span>
              <span>{{article['published at'] }}</span>
            </div>
            <div class="news__stats">
              <span>üëÅÔ∏è 12.4K views</span>
              <span>üí¨ 248 comments</span>
              <span>üî• Trending</span>
            </div>
          </div>
        </header>
        {% endif %} {% if article['status'] != 'fail' %}
        <section class="discussions">
          <h2 class="discussions__cta">Join the discussion</h2>

          <form
            class="chat-form"
            id="chat-form"
          >
            <label for="message" class="input-label"
              >What are your thoughts?</label
            >
            <textarea
              type="text"
              class="chat-input"
              id="chat-content"
              name="comment"
              placeholder="Share your thoughts and join the conversation..."
              required
            ></textarea>
            <input class="submit-btn" type="submit" value="Post Comment" />
          </form>
          {% if all_remarks %}

          <div class="chat-messages" id="messages-container">
            {% for remark in all_remarks %}
            <div class="message" data-id="{{remark.id}}">
              <div class="message__header">
                <span class="message__author">{{remark.user.username}}</span>

                <span class="message__time"
                  >{{ remark.created_at | timeago }}</span
                >
              </div>
              <div class="message__content">{{ remark.content }}</div>
           {% if remark.user == current_user %}
            <button class="delete-button" data-id="{{remark.id}}" data-category="{{active_category}}">
              <i class="fa-solid fa-trash"></i>
            </button>
            {% endif %}
            </div>
            {% endfor %} {% else %}

            <!-- <div class="empty-state" hidden>
              Be the first to share your thoughts on this story!
            </div> -->
          </div>
          {% endif %}
        </section>
        {% endif %}
      </div>
    </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>

<script type="text/javascript" charset="utf-8">
  // Connect to Socket.IO server
var socket = io();

// Get references to DOM elements we‚Äôll work with
const form = document.getElementById('chat-form');               // The chat form
const input = document.getElementById('chat-content');           // The chat input field
const messages_container = document.getElementById('messages-container'); // Where messages appear
const category = "{{ active_category }}";                        // Current news category (injected by Jinja)

// Listen for new comments broadcast from the server
socket.on('new news comment', function (data) {
    // Only show comments if they belong to the current category
    if (data.category !== category) return;

    // Create a new message div
    const message_div = document.createElement('div');
    message_div.classList.add('message');
    message_div.setAttribute('data-id', data.remark_id); // store remark id as data attribute

    // Build HTML for the message
    let html = `
        <div class="message__header">
            <span class="message__author">${data.username}</span>
            <span class="message__time">${data.timeago}</span>
        </div>
        <div class="message__content">${data.content}</div>
    `;

    // Add delete button if the current user is the author of the comment
    const current_user_username = "{{ current_user.username }}";
    if (data.username === current_user_username) {
        html += `
        <button class="delete-button" data-id="${data.remark_id}" data-category="${data.category}">
            <i class="fa-solid fa-trash"></i>
        </button>
        `;
    }

    // Insert the message HTML into the div
    message_div.innerHTML = html;

    // Add the new message at the top of the container
    messages_container.prepend(message_div);
});


// Listen for form submission: user sends a new comment
form.addEventListener('submit', function (e) {
    e.preventDefault(); // Prevent normal form submission

    const content = input.value.trim(); // Get text
    if (!content) return; // Do nothing if empty

    // Send the new comment to the server
    socket.emit('new news comment', {
        content: content,
        category: category
    });

    input.value = ''; // Clear input
});


// Listen for click events on delete buttons (event delegation)
document.addEventListener('click', function (e) {
    if (e.target.closest('.delete-button')) {
        const button = e.target.closest('.delete-button');
        const remarkId = button.dataset.id;
        const category = button.dataset.category;

        // Tell server to delete the comment
        socket.emit('delete news comment', {
            remark_id: remarkId,
        });
    }
});


// Listen for deletion events broadcast from server
socket.on('news comment deleted', function (data) {
    // Only delete if the comment is in the current category
    if (data.category !== category) return;

    // Find and remove the message element
    const messageEl = document.querySelector(`[data-id="${data.remark_id}"]`);
    if (messageEl) {
        messageEl.remove();
    }
});

</script>
  </body>
</html>

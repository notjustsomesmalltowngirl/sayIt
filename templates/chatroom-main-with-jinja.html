<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Fredoka:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Fraunces:ital,opsz,wght@0,9..144,100..900;1,9..144,100..900&family=Space+Grotesk:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="../static/sayIt-logos/logo-mono.png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="../static/styles/main.css" />

    <title>sayIt | Chatroom Main</title>
  </head>
  <body>
    <div class="chatroom-main-container chatroom-main--{{current_mood}}-container">
      <!-- <div class="floating-cicles">
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div> -->
      <!-- </div> -->
      <div class="chat__container chat__container--{{current_mood}}">
        <section class="chat chat--{{current_mood}}">
          <h1 class="join-chat join-chat--{{current_mood}}">
            <!-- use flask to change as needed -->
            ðŸŽˆ {{ greeting }} ðŸŽˆ
          </h1>
             {% if all_chats %}
          {% for chat in all_chats %}
          {% if current_mood == chat.room %}
          {% if chat.sender != current_user %}
          <article data-id="{{chat.id}}" class="chat__message chat__message--{{current_mood}}">
            <p class="chat__message-bubble chat__message-bubble--{{current_mood}}" id="chat-input">
              {{ chat.text }}
              <span class="chat__message-author chat__message-author--{{current_mood}}">
                <span class="chat__username chat__username--{{current_mood}}">{{ chat.sender.username }}</span>
                <time class="timestamp timestamp--{{current_mood}}">{{ chat.sent_at.strftime("%H:%M") }}</time>
              </span>

            </p>
          </article>
          {% else %}
          <article data-id="{{chat.id}}" class="chat__message own own--{{current_mood}} chat__message--{{current_mood}}">
            <p class="chat__message-bubble chat__message-bubble--{{current_mood}} own--bubble">
              {{ chat.text }}
              <span class="chat__message-author chat__message-author--{{current_mood}} own-author--{{current_mood}}">
                <span class="chat__username chat__username--{{current_mood}}">{{ chat.sender.username }}</span>
                <time class="timestamp timestamp--{{current_mood}}">{{ chat.sent_at.strftime("%H:%M") }}</time>
              </span>
              <span class="chat__message-icon chat__message-icon--{{current_mood}}">
                <button class="chat__message-delete chat__message-delete--{{current_mood}}" type="submit">
                  <i class="fa-solid fa-trash"></i>
                </button>
                <button class="chat__message-edit chat__message-edit--{{current_mood}}" type="submit">
                  <i class="fa-solid fa-pen"></i>
                </button>
              </span>
            </p>
          </article>
           {% endif %}
          {% endif %}
          {% endfor %}
          {% endif %}
        </section>
        <form class="chat__message-input chat__message-input--{{current_mood}}" id="chat-form">
          <textarea id="chat-field" class="chat__message-input-field chat__message-input-field--{{current_mood}}"
                    placeholder="Type your goofiest message here... ðŸ¤ª" name="chat"></textarea>
          <button class="send-btn send-btn--{{current_mood}}">ðŸš€</button>
        </form>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
          integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
          crossorigin="anonymous"></script>

<script>
const socket = io();
const room = "{{ current_mood }}";
const currentUser = "{{ current_user.username }}";

socket.emit('join_room_event', { room });
console.log('Joining room:', room);
// Chatbox reference
const chatBox = document.querySelector(`.chat.chat--${room}`);

// Send message
document.getElementById('chat-form').addEventListener('submit', function(e) {
  e.preventDefault();
    console.log('Form submitted in Edge');
  const msg = document.querySelector('[name="chat"]').value.trim();
  if (!msg) return;
  console.log('Message value:', msg);
  socket.emit('send_chat', { room, text: msg });
  console.log('Sent:', { room, text: msg });
  document.querySelector('[name="chat"]').value = '';
});

// Receive new messages
socket.on('new_message', (data) => {
 console.log('Received message in Edge:', data);
  let html;
  if (data.username === currentUser) {
    html = `
      <article data-id="${data.id}" class="chat__message own own--${room} chat__message--${room}">
        <p class="chat__message-bubble chat__message-bubble--${room} own--bubble">
          ${data.text}
          <span class="chat__message-author chat__message-author--${room} own-author--${room}">
            <span class="chat__username chat__username--${room}">${data.username}</span>
            <time class="timestamp timestamp--${room}">${data.time || ''}</time>
          </span>
          <span class="chat__message-icon chat__message-icon--${room}">
            <button class="chat__message-delete chat__message-delete--${room}" type="button">
              <i class="fa-solid fa-trash"></i>
            </button>
            <button class="chat__message-edit chat__message-edit--${room}" type="button">
              <i class="fa-solid fa-pen"></i>
            </button>
          </span>
        </p>
      </article>`;
  } else {
    html = `
      <article data-id="${data.id}" class="chat__message chat__message--${room}">
        <p class="chat__message-bubble chat__message-bubble--${room}">
          ${data.text}
          <span class="chat__message-author chat__message-author--${room}">
            <span class="chat__username chat__username--${room}">${data.username}</span>
            <time class="timestamp timestamp--${room}">${data.time || ''}</time>
          </span>
        </p>
      </article>`;
  }
  chatBox.insertAdjacentHTML('beforeend', html);
  chatBox.scrollTop = chatBox.scrollHeight;
});

// Event delegation for delete button
chatBox.addEventListener('click', function(e) {
  const deleteBtn = e.target.closest('.chat__message-delete');
  if (deleteBtn) {
    e.preventDefault();
    const chatEl = deleteBtn.closest('article');
    const chatId = chatEl.getAttribute('data-id');
    socket.emit('delete_chat', { id: chatId, room });
  }
});

// Listen for deleted messages
socket.on('deleted', (data) => {
  const chatToRemove = document.querySelector(`article[data-id="${data.id}"]`);
  if (chatToRemove) chatToRemove.remove();
});


</script>
  </body>
</html>